#!/usr/bin/env -S tea bash
# shellcheck shell=bash

set -e

d="$(cd "$(dirname "$0")/.." && pwd)"

arg0="$1"

if test -z "$TEA_PREFIX"; then
  echo "tea.xyz/brewkit: error: TEA_PREFIX unset" >&2
  exit 1
fi

if test -z "$GITHUB_TOKEN"; then
  GITHUB_TOKEN=$(tea gh auth token)
fi

if test "$arg0" = docker; then
  echo "tea.xyz/brewkit: error: invalid usage" >&2
  exit 1
elif shift; then
  # ensure this brewkit is used
  CMD="tea +deno.land ""$d/bin/pkg-$arg0"
  ADDARGS="--volume ""$d"":""$d"
else
  # we were invoked as `pkg -L` by itself
  ADDARGS="--interactive --workdir /root"
fi

STDARGS="
  --name brewkit.tea.xyz
  --rm
  --tty
  --env GITHUB_TOKEN=$GITHUB_TOKEN
  --env CLICOLOR_FORCE=1
  "

if test "$TEA_PANTRY_PATH" = "$SRCROOT"; then
  # weâ€™re running in a pantry checkout

  mkdir -p "$TEA_PANTRY_PATH/prefixes/linux"

  tea gum format "# docker pull"

  docker image pull teaxyz/cli

  tea gum format "# docker run"

  docker run \
    $STDARGS \
    $ADDARGS \
    --volume "$TEA_PANTRY_PATH":/work \
    --env SRCROOT=/work \
    --volume /root/pantry/prefixes \
    --volume "$TEA_PANTRY_PATH"/prefixes/linux:/root/.tea \
    --volume "$TEA_PREFIX/tea.xyz/var/www":/root/.tea/tea.xyz/var/www \
    --volume "$TEA_PANTRY_PATH"/projects:/root/.tea/tea.xyz/var/pantry/projects \
    --env DENO_DIR=/root/.tea/.local/.cache/deno \
    teaxyz/cli \
    $CMD "$@"
else
  if test -n "$TEA_PANTRY_PATH"; then
    ADDARGS="--volume ""$TEA_PANTRY_PATH"":/root/.tea/tea.xyz/var/pantry ""$ADDARGS"
  fi

  docker image pull teaxyz/cli

  docker run \
    $STDARGS \
    --volume "$TEA_PREFIX/tea.xyz/var":/root/.tea/tea.xyz/var \
    $ADDARGS \
    teaxyz/cli \
    $CMD "$@"
fi

# ^^ `--volume $d:$d` for debugging: so errors in brewkit are the same as paths on the host
