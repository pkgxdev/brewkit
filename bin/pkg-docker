#!/bin/sh

set -e

d="$(cd "$(dirname "$0")/.." && pwd)"

arg0="$1"

if test -z "$TEA_PREFIX"; then
  echo "tea.xyz/brewkit: error: TEA_PREFIX unset" >&2
  exit 1
fi

if test -z "$GITHUB_TOKEN"; then
  GITHUB_TOKEN=$(tea gh auth token)
fi

if test "$arg0" = docker; then
  echo "tea.xyz/brewkit: error: invalid usage" >&2
  exit 1
elif shift; then
  # ensure this brewkit is used
  CMD="tea -E ""$d/bin/pkg-$arg0"
  ADDARGS="--volume ""$d"":""$d"
else
  # we were invoked as `pkg -L` by itself
  ADDARGS="--interactive --tty --workdir /root"
fi

if test "$TEA_PANTRY_PATH" = "$SRCROOT"; then
  # weâ€™re running in a pantry checkout

  mkdir -p "$TEA_PANTRY_PATH/prefixes/linux"

  tea gum format "# docker pull"

  docker image pull teaxyz/cli

  tea gum format "# docker run"

  docker run \
    --name brewkit.tea.xyz \
    --rm \
    $ADDARGS \
    --volume "$TEA_PANTRY_PATH":/root/pantry \
    --env SRCROOT=/root/pantry \
    --volume /root/pantry/prefixes \
    --volume "$TEA_PANTRY_PATH"/prefixes/linux:/root/.tea \
    --volume "$TEA_PANTRY_PATH"/projects:/root/.tea/tea.xyz/var/pantry/projects \
    --volume "$TEA_PREFIX/tea.xyz/var/www":/root/.tea/tea.xyz/var/www \
    --volume /root/.tea/tea.xyz/v\* \
    --env GITHUB_TOKEN="$GITHUB_TOKEN" \
    --env CLICOLOR_FORCE=1 \
    --env DENO_DIR=/root/.tea/.local/.cache/deno \
    teaxyz/cli \
    $CMD "$@"
else
  if test -n "$TEA_PANTRY_PATH"; then
    ADDARGS="--env TEA_PANTRY_PATH=""$TEA_PANTRY_PATH"" ""$ADDARGS"
  fi

  docker image pull teaxyz/cli

  docker run \
    --name brewkit.tea.xyz \
    --rm \
    $ADDARGS \
    --volume "$TEA_PREFIX/tea.xyz/var":/root/.tea/tea.xyz/var \
    --env GITHUB_TOKEN="$GITHUB_TOKEN" \
    --env CLICOLOR_FORCE=1 \
    teaxyz/cli \
    $CMD "$@"
fi

# ^^ `--volume $d:$d` for debugging: so errors in brewkit are the same as paths on the host
