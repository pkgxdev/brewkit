#!/usr/bin/env -S pkgx +docker bash -eo pipefail

if [ "$1" == --help ]; then
  echo 'enables building linux on darwin' >&2
  echo 'builds are persisted to your pantry checkout' >&2
  echo >&2
  echo 'bk docker                 interactive tty of your pantry checkout' >&2
  echo 'bk docker build           same as `bk build` but in linux' >&2
  echo 'bk docker --x86-64 build  builds for intel' >&2
  exit 0
fi

if [ -n "$VERBOSE" ]; then
  set -x
fi

if [ ! -d "$PKGX_PANTRY_PATH" ]; then
  echo "error: \`brewkit docker\` can only be run from a pantry checkout" >&2
  exit 64
fi

d="$(cd "$(dirname "$0")/../.." && pwd)"

if [ -z "$GITHUB_TOKEN" ]; then
  GITHUB_TOKEN=$(pkgx gh auth token)
fi

if [ "$1" = --pull ]; then
  docker image pull pkgxdev/pkgx
  shift
fi

if [ "$1" = --x86-64 ]; then
  INTEL="--platform linux/amd64"
  shift
fi

if [ -z "$1" ]; then
  echo "no command: launching interactive container" >&2
  INTERACTIVE="-i"
  CMD="/bin/bash"
else
  CMD="/brewkit/bin/cmd/$1"
  shift
fi

VOLUME_NAME="brewkit.pkgx.dev"

# Create volume if it doesn't exist
if [ -z "$(docker volume ls -q -f name=^${VOLUME_NAME}$)" ]; then
  docker volume create ${VOLUME_NAME}
fi

exec docker run \
  --name $VOLUME_NAME \
  --rm \
  --tty \
  $INTERACTIVE $INTEL \
  --volume "$d:/brewkit" \
  --volume "$PKGX_PANTRY_PATH:/work" \
  --volume "${XDG_CACHE_HOME:-$HOME/Library/Caches/pkgx}:/root/.cache/pkgx" \
  --volume "$VOLUME_NAME:/root/.pkgx" \
  --env PKGX_PANTRY_PATH=/work \
  --env GITHUB_TOKEN=$GITHUB_TOKEN \
  --env CLICOLOR_FORCE=1 \
  --workdir /work \
  pkgxdev/pkgx \
  "$CMD" "$@"
