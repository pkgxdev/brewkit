#!/usr/bin/env -S tea bash
# shellcheck shell=bash

# --
# dependencies:
#   - gnu.org/bash: '>=4'
# --

set -eo pipefail

if test -z "$TEA_PANTRY_PATH"; then
  echo "error: TEA_PANTRY_PATH is not set" >&2
  exit 1
fi

WHERE="$(echo "$TEA_PANTRY_PATH" | cut -d: -f1)"
GIT_DIR="$WHERE/.git"

if ! test -d "$GIT_DIR"; then
  echo "error: TEA_PANTRY_PATH is not a standard git repository" >&2
  exit 1
fi

if ! git status --porcelain; then
  echo "error: git working directory is not clean" >&2
  exit 1
fi

d="$(cd "$(dirname "$0")"/.. && pwd)"
PATH="$d/libexec:$PATH"

if ! command -v ruby >/dev/null; then
  RUBY="tea +ruby-lang.org"
fi

BLEND="$($RUBY init.ts "$1")"

mkdir -p "$WHERE/projects/$BLEND"
cp -i "$d/share/TEMPLATE.pkg.yml" "$WHERE/projects/$BLEND/package.yml"

if test "$WHERE" = "$PWD"; then
  PRETTY="./projects/$BLEND/package.yml"
else
  PRETTY="$WHERE/projects/$BLEND"
fi

if test "$(git rev-parse --abbrev-ref HEAD)" != "new/$BLEND"; then
  git checkout -b "new/$BLEND" origin/main
fi

tea gum format <<EOF
# created \`$PRETTY\`

Now type \`pkg edit\` to open the yaml in your \`\$EDITOR\`

the package will need renaming before we can merge it.
we typically name packages after their homepage.

if you aren’t sure about the name you can submit and we’ll assist.
EOF

pkg edit $BLEND
